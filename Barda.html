
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Control Semanal - Construcción Bodegas</title>
  <!-- Bootstrap 5 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <!-- jQuery -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
  <!-- jsPDF y html2canvas -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <style>
    body { background: #f4f6fa; }
    .card { box-shadow: 0 4px 14px rgba(44,62,80,.07); }
    th { background: #2874A6 !important; color: #fff !important; }
    .btn-outline-danger { border-width: 2px; }
    .form-control:focus { border-color: #2874A6; box-shadow: 0 0 0 0.2rem #2874A660; }
    .table>:not(caption)>*>* { vertical-align: middle; }
    .badge { font-size: 1em; }
    @media (max-width: 768px) {
      .card { padding: 0 !important; }
      th, td { font-size: 0.97em; }
    }
  </style>
</head>
<body>
  <div class="container py-4">
    <div class="card p-4 mb-4">
      <div class="row mb-3">
        <div class="col-12 col-md-4 mb-2">
          <label class="form-label">Semana (elige día inicio):</label>
          <input type="date" class="form-control" id="input-fecha">
        </div>
        <div class="col-12 col-md-8 mb-2">
          <label class="form-label">Nombre completo del responsable:</label>
          <input type="text" class="form-control" id="input-responsable" placeholder="Escribe tu nombre">
        </div>
      </div>
      <h1 class="text-center fw-bold text-primary mb-0">Control Semanal - Bodegas</h1>
      <p class="text-center text-muted mb-3" id="showSemana"></p>
    </div>

    <!-- TABLA 1: TRABAJADORES -->
    <div class="card p-4 mb-4">
      <h5 class="mb-3 text-primary"><i class="bi bi-person-lines-fill"></i> Gasto de Trabajadores</h5>
      <div class="table-responsive">
        <table class="table table-bordered align-middle" id="tabla-trabajadores">
          <thead>
            <tr>
              <th>Nombre del trabajador</th>
              <th>Costo por día ($)</th>
              <th>Días</th>
              <th>Dinero extra ($)</th>
              <th>Total</th>
              <th></th>
            </tr>
          </thead>
          <tbody>
            <!-- Filas por default -->
            <tr>
              <td><input type="text" class="form-control nombre-trab" placeholder="Ej: Juan Pérez"></td>
              <td><input type="number" class="form-control costo-dia" min="0" value="0"></td>
              <td><input type="number" class="form-control dias" min="1" value="6"></td>
              <td><input type="number" class="form-control extra" min="0" value="0"></td>
              <td class="total-trab">$0.00</td>
              <td></td>
            </tr>
          </tbody>
          <tfoot>
            <tr>
              <td colspan="6" class="text-end">
                <button class="btn btn-success btn-sm" id="agregar-trab">+ Agregar trabajador</button>
              </td>
            </tr>
            <tr>
              <td colspan="4" class="fw-bold text-end">Total trabajadores</td>
              <td class="fw-bold text-primary fs-5" id="suma-trab">$0.00</td>
              <td></td>
            </tr>
          </tfoot>
        </table>
      </div>
    </div>

    <!-- TABLA 2: GASTOS EXTRA -->
    <div class="card p-4 mb-4">
      <h5 class="mb-3 text-primary"><i class="bi bi-cash-stack"></i> Otros Gastos Extras</h5>
      <div class="table-responsive">
        <table class="table table-bordered align-middle" id="tabla-extra">
          <thead>
            <tr>
              <th>Nombre</th>
              <th>Día comprado</th>
              <th>Precio ($)</th>
              <th></th>
            </tr>
          </thead>
          <tbody>
            <!-- 3 filas default -->
            <tr>
              <td><input type="text" class="form-control nombre-extra" placeholder="Ej: Cemento"></td>
              <td><input type="date" class="form-control fecha-extra"></td>
              <td><input type="number" class="form-control precio-extra" min="0" value="0"></td>
              <td class="text-center">
                <button class="btn btn-outline-danger btn-sm eliminar-fila">&times;</button>
              </td>
            </tr>
            <tr>
              <td><input type="text" class="form-control nombre-extra"></td>
              <td><input type="date" class="form-control fecha-extra"></td>
              <td><input type="number" class="form-control precio-extra" min="0" value="0"></td>
              <td class="text-center">
                <button class="btn btn-outline-danger btn-sm eliminar-fila">&times;</button>
              </td>
            </tr>
            <tr>
              <td><input type="text" class="form-control nombre-extra"></td>
              <td><input type="date" class="form-control fecha-extra"></td>
              <td><input type="number" class="form-control precio-extra" min="0" value="0"></td>
              <td class="text-center">
                <button class="btn btn-outline-danger btn-sm eliminar-fila">&times;</button>
              </td>
            </tr>
          </tbody>
          <tfoot>
            <tr>
              <td colspan="4" class="text-end">
                <button class="btn btn-success btn-sm" id="agregar-extra">+ Agregar gasto extra</button>
              </td>
            </tr>
            <tr>
              <td colspan="2" class="fw-bold text-end">Total extras</td>
              <td class="fw-bold text-danger fs-5" id="suma-extra">$0.00</td>
              <td></td>
            </tr>
          </tfoot>
        </table>
      </div>
    </div>

    <!-- TABLA 3: MATERIALES -->
    <div class="card p-4 mb-4">
      <h5 class="mb-3 text-primary"><i class="bi bi-bricks"></i> Materiales utilizados</h5>
      <div class="table-responsive">
        <table class="table table-bordered align-middle" id="tabla-materiales">
          <thead>
            <tr>
              <th>Material</th>
              <th>Cantidad</th>
              <th>Precio unitario ($)</th>
              <th>Total</th>
              <th></th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td><input type="text" class="form-control material-nombre" placeholder="Ej: Varilla"></td>
              <td><input type="number" class="form-control material-cant" min="0" value="0"></td>
              <td><input type="number" class="form-control material-precio" min="0" value="0"></td>
              <td class="material-total">$0.00</td>
              <td class="text-center">
                <button class="btn btn-outline-danger btn-sm eliminar-fila-mat">&times;</button>
              </td>
            </tr>
          </tbody>
          <tfoot>
            <tr>
              <td colspan="5" class="text-end">
                <button class="btn btn-success btn-sm" id="agregar-mat">+ Agregar material</button>
              </td>
            </tr>
            <tr>
              <td colspan="3" class="fw-bold text-end">Total materiales</td>
              <td class="fw-bold text-info fs-5" id="suma-mat">$0.00</td>
              <td></td>
            </tr>
          </tfoot>
        </table>
      </div>
    </div>

    <!-- RESUMEN FINAL -->
    <div class="card p-4 mb-4">
      <h5 class="text-center mb-3 text-success">Resumen Semanal</h5>
      <table class="table table-bordered mb-3">
        <tr>
          <td class="fw-bold">Total trabajadores</td>
          <td id="show-suma-trab">$0.00</td>
        </tr>
        <tr>
          <td class="fw-bold">Total extras</td>
          <td id="show-suma-extra">$0.00</td>
        </tr>
        <tr>
          <td class="fw-bold">Total materiales</td>
          <td id="show-suma-mat">$0.00</td>
        </tr>
        <tr class="table-primary">
          <td class="fw-bold fs-5">Gasto total</td>
          <td id="gasto-total" class="fw-bold fs-5">$0.00</td>
        </tr>
      </table>
      <label class="form-label fw-bold">Notas / Observaciones:</label>
      <textarea class="form-control mb-3" rows="2" placeholder="Escribe aquí cualquier observación importante..."></textarea>
      <div class="text-center">
        <button class="btn btn-primary px-4" onclick="generarPDF()">Descargar PDF</button>
      </div>
    </div>
  </div>

  <!-- Bootstrap icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">

  <script>
    // Mostrar semana seleccionada y responsable
    $("#input-fecha, #input-responsable").on('input', function() {
      const fecha = $("#input-fecha").val();
      const responsable = $("#input-responsable").val();
      let semanaTxt = "";
      if (fecha) {
        const f = new Date(fecha);
        const fin = new Date(f);
        fin.setDate(f.getDate() + 6);
        semanaTxt = `Semana del ${f.toLocaleDateString('es-MX')} al ${fin.toLocaleDateString('es-MX')}`;
      }
      $("#showSemana").html((semanaTxt ? semanaTxt + "<br>" : "") + (responsable ? `<span class="badge bg-info">Responsable: ${responsable}</span>` : ""));
    });

    // TABLA TRABAJADORES
    function recalcularTrab() {
      let suma = 0;
      $("#tabla-trabajadores tbody tr").each(function() {
        const costo = parseFloat($(this).find('.costo-dia').val()) || 0;
        const dias = parseFloat($(this).find('.dias').val()) || 0;
        const extra = parseFloat($(this).find('.extra').val()) || 0;
        const total = costo * dias + extra;
        $(this).find('.total-trab').text(`$${total.toFixed(2)}`);
        suma += total;
      });
      $("#suma-trab, #show-suma-trab").text(`$${suma.toFixed(2)}`);
      recalcularTotal();
    }
    $(document).on('input', '.costo-dia, .dias, .extra', recalcularTrab);

    $("#agregar-trab").click(function() {
      $("#tabla-trabajadores tbody").append(`
        <tr>
          <td><input type="text" class="form-control nombre-trab" placeholder="Ej: Nombre"></td>
          <td><input type="number" class="form-control costo-dia" min="0" value="0"></td>
          <td><input type="number" class="form-control dias" min="1" value="6"></td>
          <td><input type="number" class="form-control extra" min="0" value="0"></td>
          <td class="total-trab">$0.00</td>
          <td><button class="btn btn-outline-danger btn-sm eliminar-fila-trab">&times;</button></td>
        </tr>
      `);
    });

    $(document).on('click', '.eliminar-fila-trab', function() {
      $(this).closest('tr').remove();
      recalcularTrab();
    });

    // TABLA EXTRAS
    function recalcularExtra() {
      let suma = 0;
      $("#tabla-extra tbody tr").each(function() {
        const precio = parseFloat($(this).find('.precio-extra').val()) || 0;
        suma += precio;
      });
      $("#suma-extra, #show-suma-extra").text(`$${suma.toFixed(2)}`);
      recalcularTotal();
    }
    $(document).on('input', '.precio-extra', recalcularExtra);

    $("#agregar-extra").click(function() {
      $("#tabla-extra tbody").append(`
        <tr>
          <td><input type="text" class="form-control nombre-extra"></td>
          <td><input type="date" class="form-control fecha-extra"></td>
          <td><input type="number" class="form-control precio-extra" min="0" value="0"></td>
          <td class="text-center"><button class="btn btn-outline-danger btn-sm eliminar-fila">&times;</button></td>
        </tr>
      `);
    });
    $(document).on('click', '.eliminar-fila', function() {
      $(this).closest('tr').remove();
      recalcularExtra();
    });

    // TABLA MATERIALES
    function recalcularMat() {
      let suma = 0;
      $("#tabla-materiales tbody tr").each(function() {
        const cant = parseFloat($(this).find('.material-cant').val()) || 0;
        const precio = parseFloat($(this).find('.material-precio').val()) || 0;
        const total = cant * precio;
        $(this).find('.material-total').text(`$${total.toFixed(2)}`);
        suma += total;
      });
      $("#suma-mat, #show-suma-mat").text(`$${suma.toFixed(2)}`);
      recalcularTotal();
    }
    $(document).on('input', '.material-cant, .material-precio', recalcularMat);

    $("#agregar-mat").click(function() {
      $("#tabla-materiales tbody").append(`
        <tr>
          <td><input type="text" class="form-control material-nombre"></td>
          <td><input type="number" class="form-control material-cant" min="0" value="0"></td>
          <td><input type="number" class="form-control material-precio" min="0" value="0"></td>
          <td class="material-total">$0.00</td>
          <td class="text-center"><button class="btn btn-outline-danger btn-sm eliminar-fila-mat">&times;</button></td>
        </tr>
      `);
    });
    $(document).on('click', '.eliminar-fila-mat', function() {
      $(this).closest('tr').remove();
      recalcularMat();
    });

    // Calcular gasto total
    function recalcularTotal() {
      const t1 = parseFloat($("#suma-trab").text().replace('$', '')) || 0;
      const t2 = parseFloat($("#suma-extra").text().replace('$', '')) || 0;
      const t3 = parseFloat($("#suma-mat").text().replace('$', '')) || 0;
      const suma = t1 + t2 + t3;
      $("#gasto-total").text(`$${suma.toFixed(2)}`);
    }

    // Inicializar cálculos
    $(document).ready(function() {
      recalcularTrab();
      recalcularExtra();
      recalcularMat();
    });

    // PDF
    function generarPDF() {
      // Oculta botones para el PDF
      $('.btn, input[type="number"], input[type="text"], input[type="date"], textarea').attr('disabled', true);
      html2canvas(document.body, { scale: 2 }).then(canvas => {
        const imgData = canvas.toDataURL('image/png');
        const pdf = new window.jspdf.jsPDF('p', 'mm', 'a4');
        const imgProps= pdf.getImageProperties(imgData);
        const pdfWidth = pdf.internal.pageSize.getWidth();
        const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;
        pdf.addImage(imgData, 'PNG

