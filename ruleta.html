<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ruleta de Sorteo</title>
    <style>
        :root {
            --primary-color: #2e8b57;
            --secondary-color: #3cb371;
            --accent-color: #ffa500;
            --light-color: #e8f5e9;
            --dark-color: #333333;
            --success-color: #28a745;
            --danger-color: #dc3545;
            --text-color: #3a3f44;
            --title-color: #1b5e20;
            --field-bg: #f1f8e9;
            --header-bg: linear-gradient(135deg, #2e8b57, #3cb371);
            --body-bg: url("data:image/svg+xml,%3Csvg width='80' height='80' viewBox='0 0 80 80' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%233cb371' fill-opacity='0.1'%3E%3Cpath d='M50 50c0-5.523 4.477-10 10-10s10 4.477 10 10-4.477 10-10 10c0 5.523-4.477 10-10 10s-10-4.477-10-10 4.477-10 10-10zM10 10c0-5.523 4.477-10 10-10s10 4.477 10 10-4.477 10-10 10c0 5.523-4.477 10-10 10S0 25.523 0 20s4.477-10 10-10zm10 8c4.418 0 8-3.582 8-8s-3.582-8-8-8-8 3.582-8 8 3.582 8 8 8zm40 40c4.418 0 8-3.582 8-8s-3.582-8-8-8-8 3.582-8 8 3.582 8 8 8z' /%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: #f0f2f5;
            color: var(--dark-color);
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background-color: var(--primary-color);
            color: white;
            text-align: center;
            padding: 20px 0;
            margin-bottom: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .app-container {
            display: flex;
            flex-direction: column;
            gap: 30px;
        }

        @media (min-width: 768px) {
            .app-container {
                flex-direction: row;
            }
        }

        .config-panel {
            flex: 1;
            background-color: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23e8f5e9' fill-opacity='0.6'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
        }

        .ruleta-container {
            flex: 2;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            background-color: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            position: relative;
            background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23e8f5e9' fill-opacity='0.4'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--title-color);
        }

        input[type="text"],
        input[type="number"],
        textarea,
        select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
            transition: all 0.3s;
            background-color: var(--field-bg);
        }

        input[type="text"]:focus,
        input[type="number"]:focus,
        textarea:focus,
        select:focus {
            border-color: var(--secondary-color);
            outline: none;
            box-shadow: 0 0 0 3px rgba(60, 179, 113, 0.2);
        }

        button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s;
            margin-right: 10px;
            margin-bottom: 10px;
        }

        button:hover {
            background-color: var(--secondary-color);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        button:active {
            transform: translateY(0);
        }

        .btn-success {
            background-color: var(--success-color);
        }

        .btn-success:hover {
            background-color: #218838;
        }

        .btn-danger {
            background-color: var(--danger-color);
        }

        .btn-danger:hover {
            background-color: #c82333;
        }

        .btn-accent {
            background-color: var(--accent-color);
            color: var(--dark-color);
        }

        .btn-accent:hover {
            background-color: #e0b522;
        }

        .participants-list {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 10px;
            margin-bottom: 20px;
        }

        .participant-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            border-bottom: 1px solid #eee;
        }

        .participant-item:last-child {
            border-bottom: none;
        }

        .remove-btn {
            background-color: var(--danger-color);
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .remove-btn:hover {
            background-color: #c82333;
            transform: scale(1.1);
        }

        .ruleta {
            position: relative;
            width: 100%;
            max-width: 400px;
            aspect-ratio: 1;
            margin-bottom: 30px;
            transition: transform 5s cubic-bezier(0.17, 0.67, 0.83, 0.67);
            transform: rotate(0deg);
        }

        .pointer {
            position: absolute;
            top: -25px;
            left: 50%;
            transform: translateX(-50%);
            width: 30px;
            height: 40px;
            background: #c62828;
            clip-path: polygon(50% 0%, 0% 100%, 100% 100%);
            z-index: 10;
            box-shadow: 0 3px 5px rgba(0, 0, 0, 0.3);
            transition: all 0.5s;
        }
        
        .pointer-pin {
            position: absolute;
            top: 15px;
            left: 50%;
            transform: translateX(-50%);
            width: 10px;
            height: 10px;
            background: #ffeb3b;
            border-radius: 50%;
            z-index: 11;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
        }
        
        .pointer::after {
            content: "";
            position: absolute;
            bottom: -2px;
            left: 50%;
            transform: translateX(-50%);
            width: 8px;
            height: 8px;
            background: white;
            border-radius: 50%;
        }

        .controls {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 10px;
            margin-top: 20px;
        }

        .result-display {
            text-align: center;
            margin-top: 20px;
            min-height: 100px;
        }

        .winner {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--success-color);
            margin-top: 20px;
            animation: bounceIn 0.5s;
        }

        .eliminated {
            color: var(--danger-color);
            font-style: italic;
        }

        .confetti-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 9999;
            display: none;
        }

        @keyframes bounceIn {
            0% {
                transform: scale(0.3);
                opacity: 0;
            }
            50% {
                transform: scale(1.05);
                opacity: 1;
            }
            70% {
                transform: scale(0.9);
            }
            100% {
                transform: scale(1);
            }
        }

        .result-history {
            margin-top: 20px;
            max-height: 150px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 10px;
        }

        .result-item {
            padding: 5px 0;
            border-bottom: 1px solid #eee;
        }

        .result-item:last-child {
            border-bottom: none;
        }

        .config-header {
            color: var(--primary-color);
            margin-bottom: 15px;
            border-bottom: 2px solid var(--accent-color);
            padding-bottom: 5px;
        }

        .display-option {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }

        .checkbox-container {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .checkbox-container input[type="radio"],
        .checkbox-container input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .loading {
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--primary-color);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
            display: none;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .tooltip {
            position: relative;
            display: inline-block;
            cursor: pointer;
            margin-left: 5px;
            width: 18px;
            height: 18px;
            background-color: var(--accent-color);
            color: var(--dark-color);
            border-radius: 50%;
            text-align: center;
            line-height: 18px;
            font-size: 12px;
            font-weight: bold;
        }

        .tooltip .tooltiptext {
            visibility: hidden;
            width: 200px;
            background-color: var(--dark-color);
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 5px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            margin-left: -100px;
            opacity: 0;
            transition: opacity 0.3s;
            font-weight: normal;
            font-size: 14px;
        }

        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }
    </style>
</head>
<body>
    <header>
        <h1>Ruleta de Sorteo</h1>
        <p>Configura tu sorteo y selecciona ganadores de forma divertida</p>
    </header>

    <div class="container">
        <div class="app-container">
            <div class="config-panel">
                <h2 class="config-header">Configuración</h2>
                
                <div class="form-group">
                    <label for="title">Título del Sorteo</label>
                    <input type="text" id="title" placeholder="Ej: Sorteo Aniversario">
                </div>
                
                <div class="form-group">
                    <label for="game-type">Tipo de Sorteo
                        <div class="tooltip">?
                            <span class="tooltiptext">Selecciona cómo se determinará el ganador en tu sorteo</span>
                        </div>
                    </label>
                    <select id="game-type">
                        <option value="last">Último en Salir</option>
                        <option value="specific">Número Específico</option>
                        <option value="multiple">Múltiples Ganadores</option>
                        <option value="random">Aleatorio (se detiene en cualquiera)</option>
                    </select>
                </div>

                <div class="form-group" id="specific-number-container" style="display: none;">
                    <label for="specific-number">Número del Ganador (posición)</label>
                    <input type="number" id="specific-number" min="1" value="3">
                </div>

                <div class="form-group" id="multiple-winners-container" style="display: none;">
                    <label for="winners-positions">Posiciones Ganadoras (separadas por coma)</label>
                    <input type="text" id="winners-positions" placeholder="Ej: 1,3,5">
                </div>

                <div class="form-group">
                    <label>Visualización de Participantes</label>
                    <div class="display-option">
                        <div class="checkbox-container">
                            <input type="radio" id="show-numbers" name="display" value="numbers" checked>
                            <label for="show-numbers">Solo Números</label>
                        </div>
                        <div class="checkbox-container">
                            <input type="radio" id="show-names" name="display" value="names">
                            <label for="show-names">Solo Nombres</label>
                        </div>
                        <div class="checkbox-container">
                            <input type="radio" id="show-both" name="display" value="both">
                            <label for="show-both">Números y Nombres</label>
                        </div>
                    </div>
                </div>

                <h3 class="config-header">Participantes</h3>
                <div class="form-group">
                    <label for="participant-name">Nombre del Participante</label>
                    <input type="text" id="participant-name" placeholder="Nombre">
                </div>
                <div class="form-group" id="participant-number-container" style="display: none;">
                    <label for="participant-number">Número del Participante</label>
                    <input type="number" id="participant-number" min="1" placeholder="Número">
                </div>
                <div class="checkbox-container">
                    <input type="checkbox" id="manual-numbers" name="manual-numbers">
                    <label for="manual-numbers">Asignar números manualmente</label>
                </div>
                <button id="add-participant" class="btn-accent">Agregar Participante</button>
                
                <div class="participants-list" id="participants-list">
                    <!-- Los participantes se agregarán aquí -->
                </div>
            </div>

            <div class="ruleta-container">
                <h2 id="sorteo-title">Ruleta de Sorteo</h2>
                <div class="pointer">
                    <div class="pointer-pin"></div>
                </div>
                <div class="ruleta" id="ruleta">
                    <!-- La ruleta se generará aquí -->
                </div>
                <div class="loading" id="loading"></div>
                <div class="controls">
                    <button id="spin-btn" class="btn-success" disabled>Girar Ruleta</button>
                    <button id="reset-btn" class="btn-danger">Reiniciar</button>
                </div>
                <div class="result-display" id="result-display">
                    <!-- Aquí se mostrarán los resultados -->
                </div>
                <div class="result-history" id="result-history">
                    <h3>Historial</h3>
                    <!-- Aquí se mostrará el historial de resultados -->
                </div>
            </div>
        </div>
    </div>

    <div class="confetti-container" id="confetti-container"></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/canvas-confetti/1.6.0/confetti.browser.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Referencias a elementos DOM
            const titleInput = document.getElementById('title');
            const gameTypeSelect = document.getElementById('game-type');
            const specificNumberContainer = document.getElementById('specific-number-container');
            const specificNumberInput = document.getElementById('specific-number');
            const multipleWinnersContainer = document.getElementById('multiple-winners-container');
            const winnersPositionsInput = document.getElementById('winners-positions');
            const participantNameInput = document.getElementById('participant-name');
            const addParticipantBtn = document.getElementById('add-participant');
            const participantsList = document.getElementById('participants-list');
            const ruletaElement = document.getElementById('ruleta');
            const spinBtn = document.getElementById('spin-btn');
            const resetBtn = document.getElementById('reset-btn');
            const resultDisplay = document.getElementById('result-display');
            const resultHistory = document.getElementById('result-history');
            const sorteoTitle = document.getElementById('sorteo-title');
            const loading = document.getElementById('loading');
            const confettiContainer = document.getElementById('confetti-container');
            
            // Variables globales
            let participants = [];
            let results = [];
            let isSpinning = false;
            let eliminatedParticipants = [];
            let currentRound = 0;
            let winnerPositions = [];
            let nextAutoNumber = 1;
            
            // Mostrar/ocultar opciones según el tipo de juego
            gameTypeSelect.addEventListener('change', function() {
                specificNumberContainer.style.display = 
                    this.value === 'specific' ? 'block' : 'none';
                
                multipleWinnersContainer.style.display = 
                    this.value === 'multiple' ? 'block' : 'none';
            });
            
            // Mostrar/ocultar campo de número manual
            const manualNumbersCheckbox = document.getElementById('manual-numbers');
            const participantNumberContainer = document.getElementById('participant-number-container');
            
            manualNumbersCheckbox.addEventListener('change', function() {
                participantNumberContainer.style.display = 
                    this.checked ? 'block' : 'none';
            });
            
            // Actualizar título del sorteo
            titleInput.addEventListener('input', function() {
                sorteoTitle.textContent = this.value || 'Ruleta de Sorteo';
            });
            
            // Agregar participantes
            addParticipantBtn.addEventListener('click', function() {
                addParticipant();
            });
            
            participantNameInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    addParticipant();
                }
            });
            
            function addParticipant() {
                const name = participantNameInput.value.trim();
                if (name) {
                    const manualNumbersEnabled = manualNumbersCheckbox.checked;
                    let participantNumber;
                    
                    if (manualNumbersEnabled) {
                        const numberInput = document.getElementById('participant-number');
                        const manualNumber = parseInt(numberInput.value);
                        
                        // Verificar si el número ya existe
                        if (manualNumber && !isNaN(manualNumber)) {
                            const numberExists = participants.some(p => p.number === manualNumber);
                            if (numberExists) {
                                alert(`El número ${manualNumber} ya está asignado a otro participante.`);
                                return;
                            }
                            participantNumber = manualNumber;
                            nextAutoNumber = Math.max(nextAutoNumber, manualNumber + 1);
                        } else {
                            alert("Por favor, introduce un número válido para el participante.");
                            return;
                        }
                        
                        // Limpiar campo de número
                        numberInput.value = '';
                    } else {
                        participantNumber = nextAutoNumber++;
                    }
                    
                    const participant = {
                        id: Date.now(),
                        name: name,
                        number: participantNumber,
                        color: getRandomColor() // Asignar un color aleatorio
                    };
                    
                    participants.push(participant);
                    participantNameInput.value = '';
                    
                    // Ordenar participantes por número
                    participants.sort((a, b) => a.number - b.number);
                    
                    updateParticipantsList();
                    createRuleta();
                    updateControlsState();
                }
            }
            
            // Generar un color aleatorio para cada participante
            function getRandomColor() {
                const colors = [
                    '#4CAF50', '#8BC34A', '#CDDC39', '#FFC107', '#FF9800', 
                    '#FF5722', '#F44336', '#E91E63', '#9C27B0', '#673AB7', 
                    '#3F51B5', '#2196F3', '#03A9F4', '#00BCD4', '#009688',
                    '#795548', '#607D8B', '#D32F2F', '#C2185B', '#7B1FA2',
                    '#512DA8', '#303F9F', '#1976D2', '#0288D1', '#0097A7',
                    '#00796B', '#388E3C', '#689F38', '#AFB42B', '#FBC02D',
                    '#FFA000', '#F57C00', '#E64A19', '#5D4037', '#455A64'
                ];
                return colors[Math.floor(Math.random() * colors.length)];
            }
            
            function updateParticipantsList() {
                participantsList.innerHTML = '';
                
                participants.forEach(participant => {
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'participant-item';
                    
                    const infoSpan = document.createElement('span');
                    infoSpan.textContent = `${participant.number}. ${participant.name}`;
                    
                    const controlsDiv = document.createElement('div');
                    controlsDiv.className = 'participant-controls';
                    
                    const editBtn = document.createElement('button');
                    editBtn.className = 'edit-btn';
                    editBtn.innerHTML = '<i>✏️</i>';
                    editBtn.title = 'Editar participante';
                    editBtn.addEventListener('click', function() {
                        editParticipant(participant.id);
                    });
                    
                    const removeBtn = document.createElement('button');
                    removeBtn.className = 'remove-btn';
                    removeBtn.innerHTML = '×';
                    removeBtn.title = 'Eliminar participante';
                    removeBtn.addEventListener('click', function() {
                        removeParticipant(participant.id);
                    });
                    
                    controlsDiv.appendChild(editBtn);
                    controlsDiv.appendChild(removeBtn);
                    
                    itemDiv.appendChild(infoSpan);
                    itemDiv.appendChild(controlsDiv);
                    participantsList.appendChild(itemDiv);
                });
            }
            
            function editParticipant(id) {
                const participant = participants.find(p => p.id === id);
                if (!participant) return;
                
                const newName = prompt('Editar nombre del participante:', participant.name);
                if (newName !== null && newName.trim() !== '') {
                    participant.name = newName.trim();
                    updateParticipantsList();
                    createRuleta();
                }
            }
            
            function removeParticipant(id) {
                const removedParticipant = participants.find(p => p.id === id);
                participants = participants.filter(p => p.id !== id);
                
                // Si no se usan números manuales, actualizar la secuencia automática
                if (!manualNumbersCheckbox.checked) {
                    participants.forEach((participant, index) => {
                        participant.number = index + 1;
                    });
                    nextAutoNumber = participants.length + 1;
                }
                
                updateParticipantsList();
                createRuleta();
            }
            
            // Crear la ruleta
            function createRuleta() {
                if (participants.length === 0) {
                    ruletaElement.innerHTML = '<div style="text-align: center; padding: 30px;">Agrega participantes para crear la ruleta</div>';
                    return;
                }
                
                ruletaElement.innerHTML = '';
                
                const totalParticipants = participants.length;
                const anglePerSlice = 360 / totalParticipants;
                
                // Crear canvas para la ruleta
                const canvas = document.createElement('canvas');
                canvas.width = 400;
                canvas.height = 400;
                ruletaElement.appendChild(canvas);
                
                const ctx = canvas.getContext('2d');
                const center = canvas.width / 2;
                const radius = center - 10;
                
                // Dibujar segmentos de la ruleta
                for (let i = 0; i < totalParticipants; i++) {
                    const startAngle = (i * anglePerSlice) * Math.PI / 180;
                    const endAngle = ((i + 1) * anglePerSlice) * Math.PI / 180;
                    
                    // Alternar colores
                    const sliceColor = i % 2 === 0 ? 
                        'rgb(74, 30, 158, 0.8)' : 
                        'rgb(123, 82, 199, 0.8)';
                    
                    // Dibujar segmento
                    ctx.beginPath();
                    ctx.moveTo(center, center);
                    ctx.arc(center, center, radius, startAngle, endAngle);
                    ctx.closePath();
                    ctx.fillStyle = sliceColor;
                    ctx.fill();
                    ctx.lineWidth = 1;
                    ctx.strokeStyle = '#ffffff';
                    ctx.stroke();
                    
                    // Dibujar texto
                    ctx.save();
                    ctx.translate(center, center);
                    ctx.rotate(startAngle + anglePerSlice / 2);
                    
                    ctx.textAlign = 'right';
                    ctx.fillStyle = '#ffffff';
                    ctx.font = '14px Arial';
                    
                    // Mostrar número, nombre o ambos según la opción seleccionada
                    let displayText = '';
                    const displayOption = document.querySelector('input[name="display"]:checked').value;
                    
                    if (displayOption === 'numbers') {
                        displayText = participants[i].number.toString();
                    } else if (displayOption === 'names') {
                        displayText = participants[i].name;
                    } else {
                        displayText = `${participants[i].number}. ${participants[i].name}`;
                    }
                    
                    // Truncar texto largo
                    if (displayText.length > 15) {
                        displayText = displayText.substring(0, 13) + '...';
                    }
                    
                    ctx.fillText(displayText, radius - 20, 5);
                    ctx.restore();
                }
                
                // Dibujar círculo central
                ctx.beginPath();
                ctx.arc(center, center, 30, 0, Math.PI * 2);
                ctx.fillStyle = '#f3c623';
                ctx.fill();
                ctx.lineWidth = 2;
                ctx.strokeStyle = '#ffffff';
                ctx.stroke();
            }
            
            // Girar la ruleta
            spinBtn.addEventListener('click', function() {
                if (isSpinning || participants.length === 0) return;
                
                // Validar configuración
                const gameType = gameTypeSelect.value;
                let isConfigValid = true;
                
                if (gameType === 'specific') {
                    const specificNumber = parseInt(specificNumberInput.value);
                    if (isNaN(specificNumber) || specificNumber <= 0) {
                        alert('Por favor, introduce un número válido para el ganador.');
                        isConfigValid = false;
                    }
                } else if (gameType === 'multiple') {
                    const positions = winnersPositionsInput.value.trim();
                    if (positions === '' || !/^(\d+)(,\s*\d+)*$/.test(positions)) {
                        alert('Por favor, introduce posiciones válidas para los ganadores (números separados por comas).');
                        isConfigValid = false;
                    }
                }
                
                if (!isConfigValid) return;
                
                // Si todos los participantes han sido eliminados, reiniciar
                const remainingParticipants = participants.filter(
                    p => !eliminatedParticipants.includes(p.id)
                );
                
                if (remainingParticipants.length === 0) {
                    alert('Todos los participantes han sido eliminados. Reinicia el sorteo.');
                    return;
                }
                
                isSpinning = true;
                spinBtn.disabled = true;
                loading.style.display = 'block';
                
                currentRound++;
                
                // Determinar participante seleccionado
                const availableParticipants = participants.filter(
                    p => !eliminatedParticipants.includes(p.id)
                );
                
                const randomIndex = Math.floor(Math.random() * availableParticipants.length);
                const selectedParticipant = availableParticipants[randomIndex];
                
                // Calcular ángulo para que apunte al participante seleccionado
                const totalActive = availableParticipants.length;
                const activeIndex = availableParticipants.findIndex(p => p.id === selectedParticipant.id);
                const anglePerSlice = 360 / totalActive;
                const targetAngle = (activeIndex * anglePerSlice) + anglePerSlice / 2;
                
                // Calcular grados adicionales para dar varias vueltas
                const spins = 5; // Número de vueltas completas
                const extraDegrees = Math.floor(Math.random() * 360); // Grados aleatorios adicionales
                const totalRotation = (360 * spins) + (360 - targetAngle) + extraDegrees;
                
                // Animar ruleta
                ruletaElement.style.transition = 'transform 5s cubic-bezier(0.17, 0.67, 0.83, 0.67)';
                ruletaElement.style.transform = `rotate(${totalRotation}deg)`;
                
                // Animar el puntero
                const pointer = document.querySelector('.pointer');
                pointer.style.transform = 'translateX(-50%) scale(1.2)';
                setTimeout(() => {
                    pointer.style.transform = 'translateX(-50%) scale(1)';
                }, 500);
                
                // Procesar resultado después de que termine la animación
                setTimeout(() => {
                    isSpinning = false;
                    spinBtn.disabled = false;
                    loading.style.display = 'none';
                    
                    processResult(selectedParticipant);
                    updateControlsState();
                }, 5000);
            });
            
            // Procesar resultado de la ruleta
            function processResult(participant) {
                const gameType = gameTypeSelect.value;
                
                // Agregar al historial
                addToHistory(participant);
                
                // Determinar si es ganador según el tipo de juego
                let isWinner = false;
                
                if (gameType === 'last') {
                    // El último en quedar es el ganador
                    const remainingCount = participants.filter(p => !eliminatedParticipants.includes(p.id)).length;
                    
                    if (remainingCount === 1) {
                        isWinner = true;
                    } else {
                        eliminatedParticipants.push(participant.id);
                    }
                } 
                else if (gameType === 'specific') {
                    // El participante en la posición específica es el ganador
                    const position = parseInt(specificNumberInput.value);
                    if (currentRound === position) {
                        isWinner = true;
                    } else if (currentRound < position) {
                        eliminatedParticipants.push(participant.id);
                    }
                } 
                else if (gameType === 'multiple') {
                    // Varios participantes en posiciones específicas son ganadores
                    if (winnerPositions.length === 0) {
                        // Inicializar posiciones ganadoras si no se ha hecho ya
                        const positions = winnersPositionsInput.value.split(',')
                            .map(pos => parseInt(pos.trim()))
                            .filter(pos => !isNaN(pos) && pos > 0);
                        
                        if (positions.length === 0) {
                            positions.push(1); // Por defecto, el primero es ganador
                        }
                        
                        winnerPositions = positions;
                    }
                    
                    if (winnerPositions.includes(currentRound)) {
                        isWinner = true;
                    } else {
                        eliminatedParticipants.push(participant.id);
                    }
                } 
                else if (gameType === 'random') {
                    // Cualquier participante puede ser ganador
                    isWinner = true;
                }
                
                // Mostrar resultado
                displayResult(participant, isWinner);
                
                // Actualizar la ruleta para reflejar los participantes eliminados
                createRuleta();
            }
            
            // Mostrar resultado en pantalla
            function displayResult(participant, isWinner) {
                const resultElement = document.createElement('div');
                
                if (isWinner) {
                    resultElement.className = 'winner';
                    resultElement.innerHTML = `
                        <h3>¡GANADOR!</h3>
                        <p>${participant.number}. ${participant.name}</p>
                    `;
                    
                    // Mostrar confeti
                    confettiContainer.style.display = 'block';
                    confetti({
                        particleCount: 200,
                        spread: 160,
                        origin: { y: 0.6 },
                        colors: ['#ffa500', '#2e8b57', '#3cb371', '#ff6347', '#4169e1', '#9932cc']
                    });
                    
                    setTimeout(() => {
                        confettiContainer.style.display = 'none';
                    }, 5000);
                } else {
                    resultElement.className = 'eliminated';
                    resultElement.innerHTML = `
                        <p>Eliminado: ${participant.number}. ${participant.name}</p>
                    `;
                }
                
                resultDisplay.innerHTML = '';
                resultDisplay.appendChild(resultElement);
            }
            
            // Agregar al historial
            function addToHistory(participant) {
                const resultItem = document.createElement('div');
                resultItem.className = 'result-item';
                resultItem.textContent = `Ronda ${currentRound}: ${participant.number}. ${participant.name}`;
                
                // Añadir al principio para que los más recientes estén arriba
                if (resultHistory.children.length > 1) {
                    resultHistory.insertBefore(resultItem, resultHistory.children[1]);
                } else {
                    resultHistory.appendChild(resultItem);
                }
                
                // Guardar en el historial
                results.push({
                    round: currentRound,
                    participant: participant
                });
            }
            
            // Reiniciar el sorteo
            resetBtn.addEventListener('click', function() {
                if (isSpinning) return;
                
                // Confirmar reinicio
                if (participants.length > 0 && currentRound > 0) {
                    if (!confirm('¿Estás seguro de que deseas reiniciar el sorteo? Se perderán todos los resultados.')) {
                        return;
                    }
                }
                
                // Reiniciar variables
                currentRound = 0;
                eliminatedParticipants = [];
                results = [];
                winnerPositions = [];
                
                // Reiniciar UI
                ruletaElement.style.transition = 'none';
                ruletaElement.style.transform = 'rotate(0deg)';
                resultDisplay.innerHTML = '';
                resultHistory.innerHTML = '<h3>Historial</h3>';
                
                // Refrescar ruleta
                setTimeout(() => {
                    createRuleta();
                }, 50);
            });
            
            // Validar formulario y actualizar estado de botones
            function updateControlsState() {
                const gameType = gameTypeSelect.value;
                const hasParticipants = participants.length > 0;
                const hasActiveParticipants = participants.filter(p => !eliminatedParticipants.includes(p.id)).length > 0;
                let isValid = hasParticipants && hasActiveParticipants;
                
                // Verificar campos adicionales según el tipo de juego
                if (isValid && gameType === 'specific') {
                    const specificNumber = parseInt(specificNumberInput.value);
                    isValid = !isNaN(specificNumber) && specificNumber > 0;
                }
                
                if (isValid && gameType === 'multiple') {
                    const positions = winnersPositionsInput.value.trim();
                    isValid = positions !== '' && /^(\d+)(,\s*\d+)*$/.test(positions);
                }
                
                // Actualizar estado del botón de girar
                spinBtn.disabled = !isValid || isSpinning;
            }
            
            // Escuchar cambios en los campos de configuración
            gameTypeSelect.addEventListener('change', updateControlsState);
            specificNumberInput.addEventListener('input', updateControlsState);
            winnersPositionsInput.addEventListener('input', updateControlsState);
            
            // Inicializar la interfaz
            document.querySelectorAll('input[name="display"]').forEach(radio => {
                radio.addEventListener('change', createRuleta);
            });
            
            // Crear ruleta inicial
            createRuleta();
            
            // Eventos para validación
            titleInput.addEventListener('input', updateControlsState);
            participantNameInput.addEventListener('input', updateControlsState);
        });
    </script>
</body>
</html>
